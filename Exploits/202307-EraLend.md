# 202307 EraLend

## Background

On July 25, 2023, [EraLend](https://twitter.com/Era_Lend) on zkSync was exploited for ~$3.4M in a read-only reentrancy attack. The attacker manipulated the LP oracle price and exploited the EraLend USDC pool.

- Attacker address: [0xf1D076c9Be4533086f967e14EE6aFf204D5ECE7a](https://explorer.zksync.io/address/0xf1D076c9Be4533086f967e14EE6aFf204D5ECE7a)
- Exploit transactions:
  1. [0x99efebacb3edaa3ac34f7ef462fd8eed85b46be281bd1329abfb215a494ab0ef](https://explorer.zksync.io/tx/0x99efebacb3edaa3ac34f7ef462fd8eed85b46be281bd1329abfb215a494ab0ef)
  2. [0x7ac4da1ea1b0903dfabda56f713ea5e4a960a3fc34467a844d037f86ee8bfe98](https://explorer.zksync.io/tx/0x7ac4da1ea1b0903dfabda56f713ea5e4a960a3fc34467a844d037f86ee8bfe98)

* Victim contract(EraLend USDC pool): [0x1181D7BE04D80A8aE096641Ee1A87f7D557c6aeb](https://explorer.zksync.io/address/0x1181D7BE04D80A8aE096641Ee1A87f7D557c6aeb)

## Exploit Analysis

EraLend is a decentralized lending protocol on zkSync. The smart contract is originally based on Compound Finance V2. But in EraLend, users can use SyncSwap USDC/ETH LP as collateral to borrow ETH/USDC, which means EraLend oracle needs to price the LP token.

However, there is a read-only reentrancy vulnerability that exists in the [SycnSwap LP burn functions](https://github.com/syncswap/core-contracts/blob/5285a3a7b2b00ca8b7ffc5ae5ce6f6c6195e4aa7/contracts/pool/classic/SyncSwapClassicPool.sol#L200).

In the burn function, the reserve is updated after the external callback. As a result, the EraLend oracle price for SyncSwap LP token can be inflated, as it's using an incorrect reserve value for price calculation.

![1690439288919](image/202307Eralend/1690439288919.png "SyncSwapClassicPool")

Here is the attacking process:

1. The attacker provides liquidity to SyncSwap to mint SyncSwap LP tokens
2. The attacker burns SyncSwap LP, and in the SyncSwap burn callback, the LP token is priced higher by the oracle based on the old reserve value.
3. The attacker supplies the LPs to EraLend and borrows more USDC from EraLend with the inflated SyncSwap LP price.
4. Repeat the above steps.

## ![1690442205205](image/202307Eralend/1690442205205.png "Exploit Transactions")References

- [EraLend Docs](https://docs.eralend.com/)
- https://twitter.com/spreekaway/status/1683817944470396928
- https://twitter.com/Era_Lend/status/1683897328938389505
- https://coinwire.com/zksync-based-eralend-under-attack-3-4m-loss-uncovered/
- https://twitter.com/PeckShieldAlert/status/1684057782503501824
- https://twitter.com/BlockSecTeam/status/1683824959452504065
- https://twitter.com/syncswap/status/1683831056015949826
